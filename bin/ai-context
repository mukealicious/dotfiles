#!/bin/sh
#
# ai-context
#
# Generate project context for AI agents
# Shows project structure, recent activity, and current status

set -e

echo "## Project Context"
echo ""

# Show current directory
echo "### Current Directory"
echo "\`\`\`"
pwd
echo "\`\`\`"
echo ""

# Show project structure (if tree is available)
if command -v tree >/dev/null 2>&1; then
  echo "### Project Structure"
  echo "\`\`\`"
  tree -L 2 -I 'node_modules|.git|dist|build|coverage|__pycache__|*.pyc|.DS_Store' 2>/dev/null || echo "Unable to display tree"
  echo "\`\`\`"
  echo ""
else
  # Fallback to ls if tree isn't installed yet
  echo "### Directory Contents"
  echo "\`\`\`"
  ls -la | head -20
  echo "\`\`\`"
  echo ""
fi

# Show git information if in a git repository
if [ -d .git ] || git rev-parse --git-dir > /dev/null 2>&1; then
  echo "### Git Information"
  echo ""

  # Current branch
  echo "#### Current Branch"
  echo "\`\`\`"
  git branch --show-current 2>/dev/null || echo "Not on a branch"
  echo "\`\`\`"
  echo ""

  # Recent commits
  echo "#### Recent Commits"
  echo "\`\`\`"
  git log --oneline -10 2>/dev/null || echo "No commits yet"
  echo "\`\`\`"
  echo ""

  # Current status
  echo "#### Git Status"
  echo "\`\`\`"
  git status --short 2>/dev/null || echo "No git status available"
  echo "\`\`\`"
  echo ""

  # Remote information
  echo "#### Remote Repositories"
  echo "\`\`\`"
  git remote -v 2>/dev/null || echo "No remotes configured"
  echo "\`\`\`"
  echo ""
fi

# Show package.json if it exists (Node.js project)
if [ -f package.json ]; then
  echo "### Node.js Project"
  echo "#### Dependencies"
  echo "\`\`\`json"
  jq '.dependencies // {}' package.json 2>/dev/null || cat package.json | grep -A 10 '"dependencies"'
  echo "\`\`\`"
  echo ""
fi

# Show requirements.txt or pyproject.toml if they exist (Python project)
if [ -f requirements.txt ]; then
  echo "### Python Project"
  echo "#### Requirements (first 10 lines)"
  echo "\`\`\`"
  head -10 requirements.txt
  echo "\`\`\`"
  echo ""
elif [ -f pyproject.toml ]; then
  echo "### Python Project"
  echo "#### pyproject.toml (first 20 lines)"
  echo "\`\`\`toml"
  head -20 pyproject.toml
  echo "\`\`\`"
  echo ""
fi

# Show README if it exists
if [ -f README.md ]; then
  echo "### README (first 30 lines)"
  echo "\`\`\`markdown"
  head -30 README.md
  echo "\`\`\`"
  echo ""
elif [ -f readme.md ]; then
  echo "### README (first 30 lines)"
  echo "\`\`\`markdown"
  head -30 readme.md
  echo "\`\`\`"
  echo ""
fi

# Show any .env.example or config examples
if [ -f .env.example ]; then
  echo "### Environment Configuration"
  echo "#### .env.example"
  echo "\`\`\`"
  cat .env.example
  echo "\`\`\`"
  echo ""
fi

echo "---"
echo "*Generated by ai-context at $(date)*"